{% extends 'base.html' %}
{% block content %}

<!--
  Documento: resumen_socio.html — Documentación integrada

  Propósito del template
  - Mostrar el "Resumen por Socio" con filtros por Año/Mes y botones de exportación.
  - Presenta una tabla con márgenes y ganancias por cada socio.

  Rutas / funciones backend relacionadas (resumen_socio_view & resumen_socio_export)
  - resumen_socio_view (endpoint "/resumen-socio")
    - Lee filtros desde querystring:
      - Preferencia: year (int) y month (int). Convención: month 1..12, month=13 => "Todos".
      - Legacy: si no hay year/month, acepta ym con formatos: "YYYY-MM", "YYYY-*", "all".
    - Deriva el valor interno ym desde year/month:
      - year==1313 and month==13 -> ym = "all"
      - month==13 -> ym = "YYYY-*"
      - year==1313 -> ym = "none"
      - else -> ym = "YYYY-MM"
    - Genera lista ym_list (YMs disponibles) consultando tablas Compra y Venta.
    - Llama a build_resumen_socio(ym) para obtener filas y parámetros de margen.
    - Pasa al template las variables: filas, ym, ym_list, p_emp, p_ven, p_soc, year, month, current_year.
    - Si no hay datos válidos hace flash y renderiza filas vacías.

  - resumen_socio_export (endpoint "/resumen-socio/export")
    - Recibe year/month preferentemente o legacy ym.
    - Llama a build_resumen_socio(ym).
    - Exporta CSV o XLSX:
      - CSV vía csv.DictWriter (siempre disponible).
      - XLSX vía pandas + openpyxl (si pandas instalado).
    - Maneja errores simples (p. ej. falta de ym o pandas).

  Función core: build_resumen_socio(ym)
  - Objetivo: construir y normalizar el resumen por socio aplicado el filtro ym.
  - Comportamiento:
    - Interpreta ym:
      - "all"  => incluye todas las filas.
      - "YYYY-*" => filtra por year (LIKE "YYYY-%").
      - "YYYY-MM" => filtra por ese mes exacto (Venta.ym == ym / Compra.ym == ym).
      - "none" / inválido => devuelve consulta vacía (filtra id == -1).
    - Construye compras_query y ventas_query respetando el filtro.
    - Crea subconsultas agregadas por socio (ventas_sub, compras_sub) usando sum/coalesce.
    - Hace outer join con Socio para incluir todos los socios, aun sin movimientos.
    - Normaliza resultados a lista de dicts con claves:
      id, nombre, tipo, ventas_sin_iva, compras_sin_iva, gn (ganancia neta)
    - Calcula márgenes por socio usando parámetros:
      - p_emp, p_ven, p_soc (márgenes para empresa, vendedor y socio).
    - Construye filas finales con campos:
      YM, nombre_socio, Ganancia_neta, Margen_Empresa, Margen_Vendedor,
      Margen_Socios, Margen_Otros_Socios, Total_Margenes
    - Devuelve: (filas, p_emp, p_ven, p_soc)

  Variables que el template espera (proporcionadas por el backend)
  - filas: lista de dicts (cada dict contiene las claves mostradas en la tabla).
  - ym: string usado internamente ("all", "YYYY-*", "YYYY-MM", "none").
  - ym_list: lista de YMs disponibles (para compatibilidad legacy).
  - p_emp, p_ven, p_soc: parámetros numéricos de margen (float).
  - year: entero seleccionado por el usuario (o derivado).
  - month: entero seleccionado por el usuario (1..12 ó 13=Todos).
  - current_year: entero con el año actual (para generar el select de años en templates).
  - get_flashed_messages, request, url_for: funciones/objetos de Flask accesibles en el template.
  - Filtros Jinja usados: |ars (formato monetario) — debe estar registrado en Jinja desde el backend.

  Convenciones importantes
  - month: 1..12 para meses; 13 == "Todos" (usar siempre esta convención).
  - year: número de año normal; 1313 se utiliza como "Todos" de legacy (mantener compatibilidad).
  - Evitar comparar Venta.ym/Compra.ym con valores erróneos; usar ventas_query/compras_query ya filtradas.
  - Siempre usar func.coalesce en agregaciones para evitar None.
  - Preferir pasar current_year desde la vista y usarlo para generar listas de años en templates.

  Errores comunes y recomendaciones
  - Problema: usar la variable `year` seleccionada para generar el rango de opciones; esto puede producir menús de años extraños cuando se selecciona "Todos" (1313). Solución: usar current_year.
  - Mantener los "magic numbers" (13, 1313) en constantes en el backend para evitar confusiones.
  - Validar year/month en el backend antes de usarlos en consultas (asegurar int y rangos válidos).
  - Para export: comprobar tamaño y disponibilidad de pandas antes de generar XLSX.
  - Para tests: añadir pruebas unitarias para build_resumen_socio con casos "all", "YYYY-*", "YYYY-MM", "none".

  Ejemplo rápido de uso en URL:
  - /resumen-socio?year=2025&month=8      -> Resumen Agosto 2025
  - /resumen-socio?year=2025&month=13     -> Resumen todo 2025 (year-*)
  - /resumen-socio?year=1313&month=13     -> Resumen "all" (todos los años)
  - /resumen-socio?ym=2025-08             -> Legacy: equivalente a year=2025, month=8

  Mejoras sugeridas (prioridad media)
  - Extraer la lógica de parsing year/month/ym a una utilidad compartida.
  - Reemplazar números mágicos por constantes (MONTH_ALL, YEAR_ALL).
  - Añadir tests automáticos para build_resumen_socio.
  - Agregar paginación en export y en listado si la tabla crece mucho.

  -->


<div class="container py-4">
  <h2>Resumen por Socio:
    {% if year is defined %}
      {% if (year|string) == '1313' and (month|string) == '13' %}
              {% set subtitle = "Período: todos los años" %}
      {% elif (month|string) == '13' %}
              {% set subtitle = "Período: año completo" %}
      {% else %}
              {% set subtitle = "Período: " ~ (months[month_i] if month_i and month_i > 0 else (month|string)) ~ " / Año: " ~ year %}
      {% endif %}
    {% else %}
      {# fallback legacy ym #}
      {% if ym == "all" %}
              {% set subtitle = "Período: todos los años" %}
      {% elif ym and ym.endswith("-*") %}
              {% set subtitle = "Período: año " ~ ym[:4] %}
      {% elif ym and ym|length >= 7 %}
              {% set y = ym[:4] %}
              {% set mnum = (ym[5:7])|int %}
              {% set mname = months[mnum] if mnum > 0 and mnum <=12 else mnum %}
              {% set subtitle = "Período: " ~ title %}
      {% else %}
              {% set subtitle = "Período" %}
              {% endif %}
    {% endif %}

    <h2 class="me-3 mb-0"></h2>
    <span class="badge bg-warning text-dark" style="font-size: 1rem;">{{ subtitle }}</span>

    {# Mostrar totales del período (ventas/compras c/IVA y saldo) #}
    <div class="mt-2">
      <small class="text-muted">Totales del período:</small>

      <div class="d-flex gap-4 align-items-baseline mt-1 flex-wrap">
        <div><strong>Total Ventas (c/IVA):</strong> {{ (total_ventas_con_iva or 0.0) | ars }}</div>
        <div><strong>Total Compras (c/IVA):</strong> {{ (total_compras_con_iva or 0.0) | ars }}</div>
        <div><strong>Saldo (Vtas - Cmpas):</strong>
          <span class="badge bg-primary text-white" style="font-size: 1rem;">{{ (saldo_con_iva or 0.0) | ars }}</span>
        </div>
      </div>

      <div class="d-flex gap-4 align-items-baseline mt-2 flex-wrap">
        <div><strong>Total Ventas (s/IVA):</strong> {{ (total_ventas_sin_iva or 0.0) | ars }}</div>
        <div><strong>Total Compras (s/IVA):</strong> {{ (total_compras_sin_iva or 0.0) | ars }}</div>
        <div><strong>Saldo (Vtas - Cmpas):</strong>
          <span class="badge bg-warning text-dark" style="font-size: 1rem;">{{ (saldo_sin_iva or 0.0) | ars }}</span>
        </div>
      </div>

      <div class="d-flex gap-4 align-items-baseline mt-2 flex-wrap">
        <div><strong>IVA Total Ventas:</strong> {{ (total_ventas_iva_amt or 0.0) | ars }}</div>
        <div><strong>IVA Total Compras:</strong> {{ (total_compras_iva_amt or 0.0) | ars }}</div>
      <div><strong>Saldo (IVA):</strong> 
        <span class="badge bg-secondary text-white" style="font-size: 1rem;">{{ (total_iva_saldo or 0.0) | ars }} </span>
     </div>
      </div>
    </div>

  </div>

  <form class="row g-2 mb-3" method="get">
    <div class="col-auto">
      <label class="form-label">Año</label>
      <select class="form-select" name="year">
        <option value="1313" {% if request.args.get('year') is not none and (request.args.get('year')|int) == 1313 %}selected{% endif %}>Todos</option>
        {% for y in range(current_year, current_year-4, -1) %}
          <option value="{{ y }}"
            {% if (request.args.get('year') is none and y == year) or (request.args.get('year') is not none and (request.args.get('year')|int) == y) %}
              selected
            {% endif %}
          >{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto">
      <label class="form-label">Mes</label>
      <select class="form-select" name="month">
        <option value="13" {% if (month|string) == '13' %}selected{% endif %}>Todos</option>
        <option value="1"  {% if (month|string) == '1'  %}selected{% endif %}>Enero</option>
        <option value="2"  {% if (month|string) == '2'  %}selected{% endif %}>Febrero</option>
        <option value="3"  {% if (month|string) == '3'  %}selected{% endif %}>Marzo</option>
        <option value="4"  {% if (month|string) == '4'  %}selected{% endif %}>Abril</option>
        <option value="5"  {% if (month|string) == '5'  %}selected{% endif %}>Mayo</option>
        <option value="6"  {% if (month|string) == '6'  %}selected{% endif %}>Junio</option>
        <option value="7"  {% if (month|string) == '7'  %}selected{% endif %}>Julio</option>
        <option value="8"  {% if (month|string) == '8'  %}selected{% endif %}>Agosto</option>
        <option value="9"  {% if (month|string) == '9'  %}selected{% endif %}>Septiembre</option>
        <option value="10" {% if (month|string) == '10' %}selected{% endif %}>Octubre</option>
        <option value="11" {% if (month|string) == '11' %}selected{% endif %}>Noviembre</option>
        <option value="12" {% if (month|string) == '12' %}selected{% endif %}>Diciembre</option>
      </select>
    </div>

    <div class="col-auto align-self-end">
      <button class="btn btn-outline-primary" type="submit">Aplicar</button>
    </div>
    <div class="col-auto align-self-end">
      <a class="btn btn-outline-success" href="{{ url_for('resumen_socio_export', year=year, month=month, format='xlsx') }}">Exportar XLSX</a>
    </div>
    <div class="col-auto align-self-end">
      <a class="btn btn-outline-secondary" href="{{ url_for('resumen_socio_export', year=year, month=month, format='csv') }}">Exportar CSV</a>
    </div>
  </form>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
        <div class="alert alert-{{ 'warning' if cat=='warning' else cat }}" role="alert">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead>
        <tr>
          <th style="text-align: left;">Socio</th>
          <th style="text-align: right;">Ganancia Neta</th>
          <th style="text-align: right;">Margen Empresa</th>
          <th style="text-align: right;">Margen Vendedor</th>
          <th style="text-align: right;">Margen Socios</th>
          <th style="text-align: right;">Margen Otros Socios</th>
          <th style="text-align: right;">Total Márgenes</th>
          <th style="text-align: right;">Total Caja Socio</th>
          <th style="text-align: center;">Resto</th>
        </tr>
      </thead>
      <tbody>
        {% for r in filas %}
        <tr>
          <td>{{ r.nombre_socio }}</td>
          <td class="text-end">{{ r.Ganancia_neta | ars }}</td>
          <td class="text-end">{{ r.Margen_Empresa | ars }}</td>
          <td class="text-end">{{ r.Margen_Vendedor | ars }}</td>
          <td class="text-end">{{ r.Margen_Socios | ars }}</td>
          <td class="text-end">{{ r.Margen_Otros_Socios | ars }}</td>
          <td class="text-end"><span class="badge bg-warning text-dark" style="font-size: 1rem;">{{ r.Total_Margenes | ars }}</span></td>
          <td class="text-end"><span class="badge bg-info text-dark" style="font-size: 1rem;">{{ r.Total_Caja | ars }}</span></td>
          <td class="text-end">
            {% if r.nombre_socio != 'Legion' %}
              {% if r.Resto < 0 %}
                {# Si el Resto calculado es negativo, se muestra como positivo en verde #}
                <span class="badge bg-success text-white" style="font-size: 1rem;">{{ (r.Resto * -1) | ars }}</span>
              {% else %}
                {# Si el Resto calculado es positivo o cero, se muestra como negativo en rojo #}
                <span class="badge bg-danger text-white" style="font-size: 1rem;">{{ (r.Resto * -1) | ars }}</span>
              {% endif %}
            {% else %}
              {# Para 'Legion', se muestra el valor real. Verde si es >= 0, rojo si es < 0 #}
              <span class="badge {% if r.Resto >= 0 %}bg-success{% else %}bg-danger{% endif %} text-white" style="font-size: 1rem;">
                {{ r.Resto | ars }}
              </span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr><td colspan="9" class="text-center">No hay registros</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
