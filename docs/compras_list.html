{% extends 'base.html' %}
{% block content %}
<!--
  Template: compras_list.html
  Propósito: listado de Compras con filtro por Año/Mes (month: 1-12, 13 = Todos).
  Variables esperadas:
    - compras: iterable de objetos Compra (fecha, proveedor, pesos_sin_iva, iva_21, iva_105, total_con_iva, estado, descripcion)
    - year: entero (año seleccionado, pasado desde el backend)
    - month: entero o string (mes seleccionado; 13 = Todos)
    - request: objeto Flask request (se usa para comprobaciones opcionales)
  Nota: el filtrado por año/mes debe implementarse en la vista (main.py) y pasar la lista filtrada como `compras`.
-->

<div class="container py-4">
  <h2>Compras:
    
    {% if year is defined %}
      {% if (year|string) == '1313' and (month|string) == '13' %}
              {% set subtitle = "Período: todos los años" %}
      {% elif (month|string) == '13' %}
              {% set subtitle = "Período: año completo" %}
      {% else %}
              {% set subtitle = "Período: " ~ (months[month_i] if month_i and month_i > 0 else (month|string)) ~ " / Año: " ~ year %}
      {% endif %}
    {% else %}
      {# fallback legacy ym #}
      {% if ym == "all" %}
              {% set subtitle = "Período: todos los años" %}
      {% elif ym and ym.endswith("-*") %}
              {% set subtitle = "Período: año " ~ ym[:4] %}
      {% elif ym and ym|length >= 7 %}
              {% set y = ym[:4] %}
              {% set mnum = (ym[5:7])|int %}
              {% set mname = months[mnum] if mnum > 0 and mnum <=12 else mnum %}
              {% set subtitle = "Período: " ~ title %}
      {% else %}
              {% set subtitle = "Período" %}
              {% endif %}
    {% endif %}

    <h2 class="me-3 mb-0"></h2>
    <span class="badge bg-warning text-dark" style="font-size: 1rem;">{{ subtitle }}</span>
    
  </div>

<!-- Formulario de filtro por año/mes -->
<form class="row g-2 mb-3" method="get" action="{{ url_for('compras_list') }}">
  <!-- Columna año -->
  <div class="col-auto">
    <label class="form-label">Año</label>
    <select name="year" class="form-control form-select">
      <option value="1313" {% if request.args.get('year') is not none and (request.args.get('year')|int) == 1313 %}selected{% endif %}>Todos</option>
      {% for y in range(current_year, current_year-4, -1) %}
      <option value="{{ y }}" {% if (request.args.get('year') is none and y == year) or (request.args.get('year') is not none and (request.args.get('year')|int) == y) %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Columna mes -->
  <div class="col-auto">
    <label class="form-label">Mes</label>
    <select name="month" class="form-control form-select">
      <option value="13" {% if (month|string) == '13' %}selected{% endif %}>Todos</option>
      <option value="1"  {% if (month|string) == '1'  %}selected{% endif %}>Enero</option>
      <option value="2"  {% if (month|string) == '2'  %}selected{% endif %}>Febrero</option>
      <option value="3"  {% if (month|string) == '3'  %}selected{% endif %}>Marzo</option>
      <option value="4"  {% if (month|string) == '4'  %}selected{% endif %}>Abril</option>
      <option value="5"  {% if (month|string) == '5'  %}selected{% endif %}>Mayo</option>
      <option value="6"  {% if (month|string) == '6'  %}selected{% endif %}>Junio</option>
      <option value="7"  {% if (month|string) == '7'  %}selected{% endif %}>Julio</option>
      <option value="8"  {% if (month|string) == '8'  %}selected{% endif %}>Agosto</option>
      <option value="9"  {% if (month|string) == '9'  %}selected{% endif %}>Septiembre</option>
      <option value="10" {% if (month|string) == '10' %}selected{% endif %}>Octubre</option>
      <option value="11" {% if (month|string) == '11' %}selected{% endif %}>Noviembre</option>
      <option value="12" {% if (month|string) == '12' %}selected{% endif %}>Diciembre</option>
    </select>
  </div>

  <!-- Columna socio -->
  <div class="col-auto">
    <label class="form-label">Socio</label>
    <select name="socio" class="form-control form-select">
      <option value="" {% if not selected_socio %}selected{% endif %}>Todos</option>
      {% for s in socios %}
        <option value="{{ s }}" {% if selected_socio == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Columna estado -->
  <div class="col-auto">
    <label class="form-label">Estado</label>
    <select name="estado" class="form-control form-select">
      <option value="" {% if not selected_estado %}selected{% endif %}>Todos</option>
      <option value="PAGADO" {% if selected_estado == 'PAGADO' %}selected{% endif %}>Pagado</option>
      <option value="ADEUDADO" {% if selected_estado == 'ADEUDADO' %}selected{% endif %}>Adeudado</option>
    </select>
  </div>

  <!-- Botones -->
  <div class="col-auto align-self-end d-flex gap-2">
    <button class="btn btn-primary">Aplicar</button>
    <a class="btn btn-outline-primary" href="{{ url_for('compras_list', year=year, month=month, socio=selected_socio, estado=selected_estado, export='csv') }}">Exportar CSV</a>
  </div>
</form>

<div class="table-responsive">
<table class="table table-sm table-hover">
  <thead>
    <tr>
      <th>Transacción</th>
      <th>Fecha</th>
      <th>Proveedor</th>
      <th class="text-end">$ s/IVA</th><th class="text-end">IVA</th><th class="text-end">$ c/IVA</th>
      <th>Estado</th><th>Detalle</th>
    </tr>
  </thead>
  <tbody>
    {% for c in compras %}
    <tr>
      <td>
        {% if c.transaccion_id %}
          <span class="badge bg-info text-dark">{{ c.transaccion_id }}</span>
        {% endif %}
      </td>
      <td>{{ c.fecha.strftime('%d/%m/%Y') if c.fecha else '—' }}</td>
      <td>{{ c.proveedor or '—' }}</td>
      <td class="text-end">{{ (c.pesos_sin_iva or 0) | ars }}</td>
      <td class="text-end">{{ (((c.iva_21 or 0) + (c.iva_105 or 0))) | ars }}</td>
      <td class="text-end">{{ (c.total_con_iva or ((c.pesos_sin_iva or 0) + (c.iva_21 or 0) + (c.iva_105 or 0))) | ars }}</td>
      <td><span class="badge {{ 'bg-success' if (c.estado or '')=='PAGADO' else 'bg-warning text-dark' }}">{{ c.estado or '—' }}</span></td>
      <td>{{ c.descripcion or '' }}</td>
    </tr>
    {% else %}
    <tr><td colspan="8" class="text-center">No hay registros</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% endblock %}
